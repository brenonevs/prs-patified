generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum LobbyStatus {
  WAITING
  IN_PROGRESS
  VOTING
  COMPLETED
  CANCELLED
  EXPIRED
}

enum VoteStatus {
  PENDING
  APPROVED
  REJECTED
}

model User {
  id            String    @id
  name          String
  email         String    @unique
  emailVerified Boolean
  image         String?
  steamUsername String?
  hasCheated    Boolean   @default(false)
  cheatAttempts Int       @default(0)
  createdAt     DateTime
  updatedAt     DateTime
  sessions      Session[]
  accounts      Account[]
  partidasCriadas Partida[]       @relation("PartidaCreatedBy")
  podiumResults  PartidaPodium[]  @relation("PodiumUser")
  hostedLobbies       Lobby[]                @relation("LobbyHost")
  lobbyParticipations LobbyParticipant[]
  proposedRankings    LobbyProposedRanking[] @relation("ProposedRankings")
  rankedInProposals   LobbyProposedRanking[] @relation("RankedInProposal")
  lobbyVotes          LobbyVote[]

  @@map("user")
}

model Session {
  id        String   @id
  expiresAt DateTime
  token     String   @unique
  createdAt DateTime
  updatedAt DateTime
  ipAddress String?
  userAgent String?
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("session")
}

model Account {
  id                    String    @id
  accountId             String
  providerId            String
  userId                String
  user                  User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  accessToken           String?
  refreshToken          String?
  idToken               String?
  accessTokenExpiresAt  DateTime?
  refreshTokenExpiresAt DateTime?
  scope                 String?
  password              String?
  createdAt             DateTime
  updatedAt             DateTime

  @@map("account")
}

model Verification {
  id         String    @id
  identifier String
  value     String
  expiresAt DateTime
  createdAt DateTime?
  updatedAt DateTime?

  @@map("verification")
}

model Lobby {
  id              String       @id @default(cuid())
  code            String       @unique
  jogo            String
  status          LobbyStatus  @default(WAITING)
  hostId          String
  host            User         @relation("LobbyHost", fields: [hostId], references: [id], onDelete: Cascade)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  expiresAt       DateTime
  votingStartedAt DateTime?
  votingExpiresAt DateTime?
  fotoUrl         String?
  participants    LobbyParticipant[]
  proposedRanking LobbyProposedRanking[]
  votes           LobbyVote[]
  partidaId       String?      @unique
  partida         Partida?     @relation(fields: [partidaId], references: [id])

  @@index([code])
  @@index([status])
  @@map("lobby")
}

model LobbyParticipant {
  id        String    @id @default(cuid())
  lobbyId   String
  lobby     Lobby     @relation(fields: [lobbyId], references: [id], onDelete: Cascade)
  userId    String
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  joinedAt  DateTime  @default(now())
  leftAt    DateTime?
  isReady   Boolean   @default(false)

  @@unique([lobbyId, userId])
  @@index([lobbyId])
  @@map("lobby_participant")
}

model LobbyProposedRanking {
  id           String   @id @default(cuid())
  lobbyId      String
  lobby        Lobby    @relation(fields: [lobbyId], references: [id], onDelete: Cascade)
  proposedById String
  proposedBy   User     @relation("ProposedRankings", fields: [proposedById], references: [id])
  position     Int
  userId       String?
  user         User?    @relation("RankedInProposal", fields: [userId], references: [id])
  playerName   String
  version      Int      @default(1)
  createdAt    DateTime @default(now())

  @@index([lobbyId, version])
  @@map("lobby_proposed_ranking")
}

model LobbyVote {
  id       String     @id @default(cuid())
  lobbyId  String
  lobby    Lobby      @relation(fields: [lobbyId], references: [id], onDelete: Cascade)
  userId   String
  user     User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  status   VoteStatus @default(PENDING)
  version  Int
  votedAt  DateTime?

  @@unique([lobbyId, userId, version])
  @@index([lobbyId])
  @@map("lobby_vote")
}

model Partida {
  id          String   @id @default(cuid())
  jogo        String
  fotoUrl     String?
  createdAt   DateTime @default(now())
  createdById String
  createdBy   User     @relation("PartidaCreatedBy", fields: [createdById], references: [id], onDelete: Cascade)
  podium      PartidaPodium[]
  lobby       Lobby?

  @@map("partida")
}

model PartidaPodium {
  id         String   @id @default(cuid())
  partidaId  String
  partida    Partida  @relation(fields: [partidaId], references: [id], onDelete: Cascade)
  posicao    Int
  userId     String?
  user       User?    @relation("PodiumUser", fields: [userId], references: [id], onDelete: SetNull)
  playerName String

  @@map("partida_podium")
}
